<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Transaction Sync Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
        font-family: monospace;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #6c757d;
        cursor: not-allowed;
      }
      .transaction-item {
        background: #f8f9fa;
        padding: 8px;
        margin: 5px 0;
        border-radius: 4px;
        border-left: 4px solid #007bff;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”§ Transaction Sync Test</h1>
      <p>
        This script tests the transaction sync functionality to ensure your transactionIds array is
        properly maintained.
      </p>

      <div class="test-section">
        <h3>ğŸ“Š Database Status</h3>
        <button onclick="initializeDatabases()">ğŸ”„ Initialize Databases</button>
        <button onclick="checkUserStatus()">ğŸ‘¤ Check Current User</button>
        <div id="dbStatus"></div>
      </div>

      <div class="test-section">
        <h3>ğŸ” Transaction Analysis</h3>
        <button onclick="analyzeTransactions()">ğŸ” Analyze Transactions</button>
        <button onclick="syncTransactionIds()">ğŸ”„ Sync Transaction IDs</button>
        <div id="transactionAnalysis"></div>
      </div>

      <div class="test-section">
        <h3>âœ… Test Transaction Management</h3>
        <button onclick="testAddTransaction()">â• Test Add Transaction</button>
        <button onclick="testDeleteTransaction()">ğŸ—‘ï¸ Test Delete Transaction</button>
        <div id="testResults"></div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/pouchdb@7.3.1/dist/pouchdb.min.js"></script>
    <script>
      let localDB, remoteDB
      let currentUser = null

      function log(elementId, message, type = 'info') {
        const element = document.getElementById(elementId)
        const div = document.createElement('div')
        div.className = `result ${type}`
        div.innerHTML = `<strong>${new Date().toLocaleTimeString()}:</strong> ${message}`
        element.appendChild(div)
        element.scrollTop = element.scrollHeight
      }

      async function initializeDatabases() {
        try {
          log('dbStatus', 'Initializing databases...', 'info')

          localDB = new PouchDB('finance_local')
          remoteDB = new PouchDB('https://server.themission.site/mywallet_db', {
            auth: { username: 'root', password: 'Sharpest2Mind' },
          })

          // Load current user from localStorage
          const savedUser = localStorage.getItem('currentUser')
          if (savedUser && savedUser !== 'undefined') {
            currentUser = JSON.parse(savedUser)
            log('dbStatus', `âœ… Loaded user: ${currentUser.email}`, 'success')
            log(
              'dbStatus',
              `ğŸ“ Current transactionIds: [${(currentUser.transactionIds || []).join(', ')}]`,
              'info',
            )
          } else {
            log('dbStatus', 'âŒ No user found in localStorage. Please log in first.', 'error')
          }

          log('dbStatus', 'âœ… Databases initialized successfully', 'success')
        } catch (error) {
          log('dbStatus', `âŒ Failed to initialize: ${error.message}`, 'error')
        }
      }

      async function checkUserStatus() {
        if (!currentUser) {
          log('dbStatus', 'âŒ No current user. Please initialize databases first.', 'error')
          return
        }

        try {
          const userDoc = await localDB.get(currentUser._id)
          log('dbStatus', `âœ… User document found in local DB`, 'success')
          log(
            'dbStatus',
            `ğŸ“ User transactionIds count: ${(userDoc.transactionIds || []).length}`,
            'info',
          )

          // Also check remote
          try {
            const remoteUser = await remoteDB.get(currentUser._id)
            log('dbStatus', `âœ… User document found in remote DB`, 'success')
          } catch (remoteError) {
            log('dbStatus', `âš ï¸ User not found in remote DB: ${remoteError.message}`, 'error')
          }
        } catch (error) {
          log('dbStatus', `âŒ User document not found in local DB: ${error.message}`, 'error')
        }
      }

      async function analyzeTransactions() {
        if (!currentUser) {
          log(
            'transactionAnalysis',
            'âŒ No current user. Please initialize databases first.',
            'error',
          )
          return
        }

        try {
          // Get transactions by userId query
          const result = await localDB.find({
            selector: {
              type: 'transaction',
              userId: currentUser._id,
            },
          })

          const queryTransactions = result.docs
          const queryIds = queryTransactions.map((t) => t._id)

          log(
            'transactionAnalysis',
            `ğŸ” Found ${queryTransactions.length} transactions by userId query`,
            'success',
          )
          log('transactionAnalysis', `ğŸ“‹ Query transaction IDs: [${queryIds.join(', ')}]`, 'info')

          // Get user's stored transactionIds
          const storedIds = currentUser.transactionIds || []
          log('transactionAnalysis', `ğŸ’¾ Stored transactionIds count: ${storedIds.length}`, 'info')
          log('transactionAnalysis', `ğŸ’¾ Stored IDs: [${storedIds.join(', ')}]`, 'info')

          // Compare
          const missingFromStorage = queryIds.filter((id) => !storedIds.includes(id))
          const orphanedInStorage = storedIds.filter((id) => !queryIds.includes(id))

          if (missingFromStorage.length > 0) {
            log(
              'transactionAnalysis',
              `âš ï¸ Missing from storage: [${missingFromStorage.join(', ')}]`,
              'error',
            )
          }

          if (orphanedInStorage.length > 0) {
            log(
              'transactionAnalysis',
              `âš ï¸ Orphaned in storage: [${orphanedInStorage.join(', ')}]`,
              'error',
            )
          }

          if (missingFromStorage.length === 0 && orphanedInStorage.length === 0) {
            log(
              'transactionAnalysis',
              'âœ… TransactionIds array is perfectly synchronized!',
              'success',
            )
          }

          // Show transaction details
          if (queryTransactions.length > 0) {
            log('transactionAnalysis', 'ğŸ“Š Transaction Details:', 'info')
            queryTransactions.forEach((t, index) => {
              const div = document.createElement('div')
              div.className = 'transaction-item'
              div.innerHTML = `<strong>${index + 1}. ${t._id}</strong><br>
                                       Amount: ${t.amount} (${t.kind})<br>
                                       Category: ${t.categoryId}<br>
                                       Date: ${new Date(t.datetime).toLocaleString()}`
              document.getElementById('transactionAnalysis').appendChild(div)
            })
          }
        } catch (error) {
          log('transactionAnalysis', `âŒ Failed to analyze transactions: ${error.message}`, 'error')
        }
      }

      async function syncTransactionIds() {
        if (!currentUser) {
          log(
            'transactionAnalysis',
            'âŒ No current user. Please initialize databases first.',
            'error',
          )
          return
        }

        try {
          log('transactionAnalysis', 'ğŸ”„ Syncing transactionIds...', 'info')

          // Get actual transactions
          const result = await localDB.find({
            selector: {
              type: 'transaction',
              userId: currentUser._id,
            },
          })

          const actualIds = result.docs.map((t) => t._id)

          // Update user document
          const userDoc = await localDB.get(currentUser._id)
          userDoc.transactionIds = actualIds
          userDoc.updatedAt = new Date().toISOString()

          await localDB.put(userDoc)

          // Update localStorage
          localStorage.setItem('currentUser', JSON.stringify(userDoc))
          currentUser = userDoc

          log(
            'transactionAnalysis',
            `âœ… Synced transactionIds: [${actualIds.join(', ')}]`,
            'success',
          )
          log('transactionAnalysis', `ğŸ“Š Now have ${actualIds.length} transaction IDs`, 'info')
        } catch (error) {
          log('transactionAnalysis', `âŒ Failed to sync: ${error.message}`, 'error')
        }
      }

      async function testAddTransaction() {
        if (!currentUser) {
          log('testResults', 'âŒ No current user. Please initialize databases first.', 'error')
          return
        }

        try {
          log('testResults', 'â• Testing add transaction...', 'info')

          // Create test transaction
          const testTransaction = {
            _id: `test_transaction_${Date.now()}`,
            type: 'transaction',
            userId: currentUser._id,
            walletId: currentUser.walletId,
            kind: 'expense',
            amount: 25.5,
            categoryId: (currentUser.categoryIds || [])[0] || 'test-category',
            datetime: new Date().toISOString(),
            notes: 'Test transaction for sync verification',
            tags: [],
            splitPayment: { isSplit: false, splitDetails: {} },
          }

          await localDB.put(testTransaction)

          // Update user's transactionIds
          const userDoc = await localDB.get(currentUser._id)
          const currentIds = userDoc.transactionIds || []
          userDoc.transactionIds = [...currentIds, testTransaction._id]
          userDoc.updatedAt = new Date().toISOString()

          await localDB.put(userDoc)
          localStorage.setItem('currentUser', JSON.stringify(userDoc))
          currentUser = userDoc

          log('testResults', `âœ… Test transaction added: ${testTransaction._id}`, 'success')
          log(
            'testResults',
            `ğŸ“ Updated transactionIds count: ${userDoc.transactionIds.length}`,
            'info',
          )

          // Clean up test transaction
          setTimeout(async () => {
            try {
              await localDB.remove(testTransaction)
              const userDoc = await localDB.get(currentUser._id)
              userDoc.transactionIds = userDoc.transactionIds.filter(
                (id) => id !== testTransaction._id,
              )
              await localDB.put(userDoc)
              localStorage.setItem('currentUser', JSON.stringify(userDoc))
              currentUser = userDoc
              log('testResults', `ğŸ§¹ Test transaction cleaned up`, 'info')
            } catch (cleanupError) {
              log(
                'testResults',
                `âš ï¸ Failed to clean up test transaction: ${cleanupError.message}`,
                'error',
              )
            }
          }, 2000)
        } catch (error) {
          log('testResults', `âŒ Failed to test add transaction: ${error.message}`, 'error')
        }
      }

      async function testDeleteTransaction() {
        if (!currentUser) {
          log('testResults', 'âŒ No current user. Please initialize databases first.', 'error')
          return
        }

        try {
          log('testResults', 'ğŸ—‘ï¸ Testing delete transaction...', 'info')

          // Get first transaction
          const result = await localDB.find({
            selector: {
              type: 'transaction',
              userId: currentUser._id,
            },
            limit: 1,
          })

          if (result.docs.length === 0) {
            log('testResults', 'âš ï¸ No transactions found to delete', 'error')
            return
          }

          const transactionToDelete = result.docs[0]

          // Delete transaction
          await localDB.remove(transactionToDelete)

          // Update user's transactionIds
          const userDoc = await localDB.get(currentUser._id)
          userDoc.transactionIds = (userDoc.transactionIds || []).filter(
            (id) => id !== transactionToDelete._id,
          )
          userDoc.updatedAt = new Date().toISOString()

          await localDB.put(userDoc)
          localStorage.setItem('currentUser', JSON.stringify(userDoc))
          currentUser = userDoc

          log('testResults', `âœ… Test transaction deleted: ${transactionToDelete._id}`, 'success')
          log(
            'testResults',
            `ğŸ“ Updated transactionIds count: ${userDoc.transactionIds.length}`,
            'info',
          )
        } catch (error) {
          log('testResults', `âŒ Failed to test delete transaction: ${error.message}`, 'error')
        }
      }

      // Auto-initialize when page loads
      window.addEventListener('load', () => {
        log('dbStatus', 'ğŸš€ Page loaded. Click "Initialize Databases" to start.', 'info')
      })
    </script>
  </body>
</html>
